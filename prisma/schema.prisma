generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  GUEST       // Default until they select a role
  STUDENT
  TEACHER
  ADMIN
}

enum ResourceStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum TagSource {
  SYSTEM  // System-generated (migrated from hierarchy)
  USER    // User-created (custom tags)
}

enum ResourceSource {
  SYSTEM  // Migrated resources or admin-uploaded
  USER    // User-uploaded resources
}

// --- USER & AUTH ---

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  googleId      String?   @unique // To link Google Account securely
  name          String?
  imageUrl      String?   // From Google Profile
  
  role          Role      @default(GUEST) 
  isOnboarded   Boolean   @default(false) // True after they select Student/Teacher
  
  createdAt     DateTime  @default(now())
  
  // Relations
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  
  uploads        Resource[]     @relation("UserUploads")
  announcements  Announcement[]
  
  // Forum Relations
  questions      Question[]
  answers        Answer[]
  votes          Vote[]         // Keeping track of what they upvoted
}

model StudentProfile {
  id        String   @id @default(uuid())
  school    String?  // e.g. "Royal College"
  batch     String?  // e.g. "2025 A/L"
  
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  
  // Interests (Linked to Tags like "Combined Maths")
  interests Tag[] 
}

model TeacherProfile {
  id             String   @id @default(uuid())
  bio            String?  @db.Text
  qualifications String?
  
  whatsappNumber String?
  telegramUser   String?
  
  isAvailable    Boolean  @default(true)
  
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  
  subjects       Tag[]
}

// --- FORUM (Q&A) ---

model Question {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text // Supports Markdown/HTML
  slug        String   @unique  // for SEO: /forum/how-to-solve-integration-q1
  
  views       Int      @default(0)
  isSolved    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  
  tags        Tag[]        // Forum tags: "Physics", "Mechanics"
  answers     Answer[]
}

model Answer {
  id          String   @id @default(uuid())
  content     String   @db.Text
  
  isAccepted  Boolean  @default(false) // If the student marks this as the correct answer
  upvotes     Int      @default(0)     // Calculated count
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  questionId  String
  question    Question @relation(fields: [questionId], references: [id])
  
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  
  votes       Vote[]   // Who voted on this answer?
}

// To prevent spam voting (1 user = 1 vote per answer)
model Vote {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  answerId  String
  answer    Answer   @relation(fields: [answerId], references: [id])
  
  @@unique([userId, answerId]) // User can only vote once per answer
}

// --- TAGS & RESOURCES ---

model StorageNode {
  id             Int      @id @default(autoincrement())
  name           String   @unique  // e.g. "Default Storage", "Sri Lanka Server"
  email          String   @unique  // Google Drive account email
  refreshToken   String   @db.Text // OAuth2 refresh token (encrypted in production)
  totalSpace     BigInt   @default(0) // In bytes
  usedSpace      BigInt   @default(0)
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  resources      Resource[]
}

model Tag {
  id             String      @id @default(uuid())
  name           String      @unique
  slug           String      @unique
  group          String?     // e.g. "Grade", "Subject", "Lesson", "Medium", "ResourceType"
  source         TagSource   @default(USER) // SYSTEM for migrated, USER for custom tags
  
  // Hierarchy
  parentId       String?
  parent         Tag?        @relation("TagHierarchy", fields: [parentId], references: [id])
  children       Tag[]       @relation("TagHierarchy")

  createdAt      DateTime    @default(now())
  
  // Relations
  resources          Resource[]
  questions          Question[]
  teacherProfiles    TeacherProfile[]
  studentProfiles    StudentProfile[]
}

model Resource {
  id          String         @id @default(uuid())
  title       String
  description String?        @db.Text
  
  driveFileId String?  // Copied file ID in upload folder (after migration)
  mimeType    String?  
  fileSize    BigInt?  
  externalUrl String? 

  status      ResourceStatus @default(PENDING)
  source      ResourceSource @default(USER) // SYSTEM for migrated/admin, USER for user-uploaded
  views       Int            @default(0)
  downloads   Int            @default(0)
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tags          Tag[]
  
  storageNodeId Int?
  storageNode   StorageNode? @relation(fields: [storageNodeId], references: [id])
  
  uploaderId    String
  uploader      User         @relation("UserUploads", fields: [uploaderId], references: [id])

  @@index([title])
  @@index([status])
  @@index([source])
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String   @db.Text 
  priority  Priority @default(NORMAL)
  isActive  Boolean  @default(true) 
  expiresAt DateTime? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
}

enum Priority {
  NORMAL
  HIGH
  CRITICAL
}
